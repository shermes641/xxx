## HMAC Signature
To authenticate server to server callbacks, we will be sending an HMAC signature in the request query string.

There is no requirement for the distributor to decode the HMAC signature, or include it in any requests to the Mediation server.

The sole purpose of adding the HMAC signature is to prove a request came from the Mediation server.

#### Generating an HMAC Signature

A signature is generated by calculating a digest using the HMAC-SHA256 hashing algorithm.
The inputs to the hashing algorithm include a shared secret and a normalized string that represents the current request.

        The shared secret will be created when an app is created ( apps table, hmac_secret column )
        Therefore each application will have it's own shared secret.
        If the distributor wants to validate the HMAC signature, he will need this value.
        The shared secret and callback URL are exposed on the "App Configuration" dialog

To build the pre-hashed string the following elements are concatenated separated by **+** :

1. A timestamp value calculated for the request.
2. A nonce value generated for the request.

        This will be the transaction ID of the completion ( completions table, transaction_id column )

3. The ad provider callback to the mediation server entity-body hash.

   Example body parameters: (only a common subset of parameters common amongst all ad providers are used)

        {"original_postback":{"method":"GET","path":"/v1/reward_callbacks/47bc1b3b-9d85-4cbe-9bfd-c8edb31f415e/hyprmarketplace","query":{
            "quantity":"1",
            "offer_profit":"0.01",
            "sig":"e4cd4703e0de9e987980a3ea18677844c5dda9ebacdf776b8af7e7a53f546f59",
            "reward_id":"0",
            "sub_id":"9C8360C2AEAE-498A-9A87-9673F568A394",
            "uid":"iOS_mb_release",
            "time":"1460487629"
          }},
          "ad_provider":"HyprMarketplace",
          "reward_quantity":2,
          "estimated_offer_profit":0.01,
          "transaction_id":"9C8360C2-AEAE-498A-9A87-9673F568A394"
         }

4. The HTTP request method in upper case: POST

5.  The encoded callback URL from the application configuration

6. The request port, 80 for http, 443 for https

#### HMAC Signature Example

**Application callback URL**

        http://requestb.in/1fkadcg1?inspect

**With the following parameters:**

        Shared Secret:  83205a39-839f-48e9-9ad9-e5ef99956bb1
        Timestamp:      146048762
        Nonce:          9C8360C2-AEAE-498A-9A87-9673F568A394

**The pre-hashed string would look like the following:**

    146048762+9C8360C2-AEAE-498A-9A87-9673F568A394+adProviderName=HyprMarketplace+estimatedOfferProfit=0.01+rewardQuantity=2+transactionId=9C8360C2-AEAE-498A-9A87-9673F568A394+POST+http%3A%2F%2Frequestb.in%2F1fkadcg1%3Finspect+80

**Breakdown of pre-hashed string** (on multiple lines for clarity)

    146048762+                                             QUERYSTRING section timestamp
    9C8360C2-AEAE-498A-9A87-9673F568A394+                  QUERYSTRING section nonce
    adProviderName=HyprMarketplace+                        RAW BODY section    ad_provider
    estimatedOfferProfit=0.01+                             RAW BODY section    estimated_offer_profit
    rewardQuantity=2+                                      RAW BODY section    reward_quantity
    transactionId=9C8360C2-AEAE-498A-9A87-9673F568A394+    RAW BODY section    transaction_id
    POST+                                                  request method
    http%3A%2F%2Frequestb.in%2F1fkadcg1%3Finspect+         Encoded callback url
    80                                                     http port

After calculating the HMAC signature, it is base64 encoded.

        digest = HMAC-SHA256 ( Shared Secret, prehashed_string )
        hmac = base64 ( digest )

This request would generate the following query string values. (spaces added between parameters for readability)

       ?timestamp="146048762"& nonce="9C8360C2-AEAE-498A-9A87-9673F568A394"& hmac="teYfbAhDjhIdYu+0I8qtdp+2/KiYKfnrmr/gwXYgOio="

### Testing

Get the App's shared secret:

83205a39-839f-48e9-9ad9-e5ef99956bb1


Find your request at   http://requestb.in/1fkadcg1?inspect (line breaks added for readability)

    QUERYSTRING

    timestamp: 146048762
    hmac: IlMSOhCRhrpmHyQDCKVDYouilbd8fd5eiqVdSp5wUMo=
    nonce: 9C8360C2-AEAE-498A-9A87-9673F568A394

    RAW BODY

    {"original_postback":{"method":"GET","path":"/v1/reward_callbacks/47bc1b3b-9d85-4cbe-9bfd-c8edb31f415e/hyprmarketplace","query":{
        "quantity":"1",
        "offer_profit":"0.01",
        "sig":"e4cd4703e0de9e987980a3ea18677844c5dda9ebacdf776b8af7e7a53f546f59",
        "reward_id":"0",
        "sub_id":"9C8360C2AEAE-498A-9A87-9673F568A394",
        "uid":"iOS_mb_release",
        "time":"1460487629"
      }},
      "ad_provider":"HyprMarketplace",
      "reward_quantity":2,
      "estimated_offer_profit":0.01,
      "transaction_id":"9C8360C2-AEAE-498A-9A87-9673F568A394"
     }

In paper trail find "Distributor hmac POST:"
Copy the line below it:

Example line to copy:

    146048762+9C8360C2-AEAE-498A-9A87-9673F568A394+adProviderName=HyprMarketplace+estimatedOfferProfit=0.01+rewardQuantity=2+transactionId=9C8360C2-AEAE-498A-9A87-9673F568A394+POST+http%3A%2F%2Frequestb.in%2F1fkadcg1%3Finspect+80

Verify that adProviderName estimatedOfferProfit rewardQuantity and transactionId match "ad_provider" reward_quantity" "estimated_offer_profit" and "transaction_id" from  http://requestb.in/1fkadcg1?inspect RAW BODY
Ignore the plus sign after each element.

Go to http://www.freeformatter.com/hmac-generator.html#ad-output

Paste the line into the "Copy-paste the message here" text box
Copy your shared secret into the "Secret Key" text box
Select "SHA256" in the "Select a message digest algorithm" list box
Click "COMPUTE HMAC"

Copy the text in the "Computed HMAC (in Hex):" text box
Goto http://tomeko.net/online_tools/hex_to_base64.php
Paste the text into the "Hex string:" text box
The text in the "Output (base64):" text box should match the hmac: value from the http://requestb.in/1fkadcg1?inspect QUERYSTRING section

    146048762+                                             QUERYSTRING section timestamp
    9C8360C2-AEAE-498A-9A87-9673F568A394+                  QUERYSTRING section nonce
    adProviderName=HyprMarketplace+                        RAW BODY section    ad_provider
    estimatedOfferProfit=0.01+                             RAW BODY section    estimated_offer_profit
    rewardQuantity=2+                                      RAW BODY section    reward_quantity
    transactionId=9C8360C2-AEAE-498A-9A87-9673F568A394+    RAW BODY section    transaction_id
    POST+
    http%3A%2F%2Frequestb.in%2F1fkadcg1%3Finspect+         Encoded callback url
    80
